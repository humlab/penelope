from __future__ import annotations

import uuid

import pandas as pd

from penelope.vendor import mallet_api

DOCTOPICS_SAMPLE: str = """#doc name topic proportion ...
0	0	324	0.12262526333466872	74	0.10506107068300177	290	0.07608652371948554	335	0.07313325744105728	104	0.07277324807034467	97	0.06897874713517153	458	0.062347804624217705	139	0.04659284191910738	91	0.04284124909300346	146	0.03783012943055252
1	1	91	0.17540446780620148	6	0.12832807235135876	299	0.11104279547352393	69	0.07612307373547192	236	0.07375234736240824	148	0.05877254360156277	133	0.05665862712565255	466	0.042971735900893884	19	0.0209810744446003
2	2	352	0.15846956124280073	299	0.11317983693152944	37	0.07759435270963765	135	0.07566232382564402	465	0.05881779825270418	104	0.052904364596398495	6	0.04623346610095504	91	0.04316600720167707
3	3	94	0.16426018446099913	380	0.12367477314766004	299	0.11503489994627653	6	0.0925661864852677	225	0.08526829656172981	400	0.06730237464990718	358	0.05538163283728708
4	4	331	0.17294092428475283	160	0.014245118249621054	135	0.011235320150945005
5	5	91	0.2893194083919773	94	0.17252678161058468	299	0.13211816868085532	7	0.05335555993978352	12	0.03232327653639319	234	0.024728999911210414	292	0.018300312069896102
6	6	126	0.16251823693391926	380	0.1069692485406306	299	0.09099398831937176	36	0.08473998590872439	94	0.08103122617520592	335	0.07272367217508677	458	0.04180929480360436
7	7	380	0.16251737357055215	94	0.14104542860914376	335	0.12011152399959996	121	0.06698436842135064	465	0.044725039992665215	133	0.042317739969363166	475	0.04174922274559652
8	8	3	0.25055583982513113	312	0.14874593052235704	36	0.12964989143925426	234	0.02191826082917291	458	0.020241559464423704	29	0.019468929792018946
9	9	331	0.17294092428475283	351	0.012495140968755602	135	0.011235320150945005
"""


def test_convert_doctopics():

    source_filename: str = f"./tests/output/doctopics_{str(uuid.uuid4())[:6]}.txt"
    with open(source_filename, "w") as fp:
        fp.write(DOCTOPICS_SAMPLE)

    df: pd.DataFrame = mallet_api.doctopics_to_dataframe(
        source_filename=source_filename, normalize=False, epsilon=0.005
    )
    assert df is not None

    df = df.set_index(['document_id', 'topic_id'])

    assert set(df.index.levels[0]) == {0, 1, 2, 3, 4, 5, 6, 7, 8, 9}
    assert df.loc[0, 324].weight == 0.12262526333466872
    assert len(df.loc[9]) == 3
    assert len(df.loc[1]) == 9
    assert df.loc[5, 292].weight == 0.018300312069896102

    df: pd.DataFrame = mallet_api.doctopics_to_dataframe(source_filename=source_filename, normalize=True, epsilon=0.005)
